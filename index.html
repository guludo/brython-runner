<!doctype html>
<html>
<head>
    <script src="node_modules/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="node_modules/codemirror/theme/ayu-mirage.css">
    <script src="node_modules/codemirror/mode/python/python.js"></script>
    <script src="node_modules/codemirror/addon/comment/comment.js"></script>
    <script src="node_modules/codemirror/keymap/sublime.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="/assets/brython-runner.bundle.js"></script>
</head>
<body>
    <div class="dev-box">
        <div class="toolbar-row">
            <button class="toolbar-button" onclick="run()">
                Run
            </button>
            <button class="toolbar-button" onclick="runUrl()">
                Run URL
            </button>
        </div>
        <div class="workspace-row">
            <div class="editor-column">
                <div class="editor" id="editor"></div>
            </div>
            <div class="run-column">
                <div class="output-box" id="output">

                </div>
            </div>
        </div>
    </div>
    <script>
        // Initialize the code editor.
        const CODEMIRROR_OPTIONS = {
            lineNumbers: true,
            lineSeparator: '\n',
            mode: undefined,
            theme: 'ayu-mirage',
            fontSize: 14,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true,
            readOnly: false,
            smartIndent: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            showTrailingSpace: true,
            keyMap: 'sublime',
            extraKeys: null,
            showInvisibles: true,
            viewportMargin: Infinity,
        }
        const codeStoreKey = 'brython-runner-dev-code'
        const loadedCode = localStorage.getItem(codeStoreKey)
        const code = loadedCode || ''
        const editor = CodeMirror(document.getElementById('editor'), {
            ...CODEMIRROR_OPTIONS,
            mode: 'python',
            value: code,
        })
        editor.on('change', (editor, change) => {
            localStorage.setItem(codeStoreKey, editor.getDoc().getValue())
        })
        const runner = new BrythonRunner({
            staticUrl: '/static',
            cwdUrl: '/static/brython_test',
            stdout: {
                write(content) {
                    var el = document.createElement('code');
                    var text = document.createTextNode(content);
                    el.appendChild(text)
                    document.getElementById('output').appendChild(el);  
                },
                flush() {}
            },
            stderr: {
                write(content) {
                    var el = document.createElement('code');
                    var text = document.createTextNode(content);
                    el.appendChild(text)
                    el.setAttribute('class', 'error')
                    document.getElementById('output').appendChild(el);
                },
                flush() { }
            },
        })
        function clearOutput() {
            document.getElementById('output').innerHTML = ''
        }
        function getCode() {
            return editor.getDoc().getValue();
        }
        function run() {
            clearOutput()
            const code = getCode();
            runner.runCode(code);
        }
        function runUrl() {
            clearOutput()
            runner.runUrl('/static/brython_test/test.py');
        }
    </script>
    </body>
</html>